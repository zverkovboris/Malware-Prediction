
# Catboost model


```python
import pickle
import numpy as np
import catboost as cb
import pandas as pd
from sklearn.model_selection import train_test_split
from Column_types import dtypes
import gc
gc.enable()
```


```python
categories = list(filter(lambda x : dtypes[x] == 'category', dtypes))
categories.remove('MachineIdentifier')
categories
```


```python
def load_file(filename, ids=False):
    data = pd.read_csv(filename, dtype=dtypes)
    submit = data[['MachineIdentifier']]
    data = data.drop('MachineIdentifier', axis=1)
    data = data.replace(np.nan,0)
    if ids:
        return data,submit
    else:
        return data
```


```python
train = load_file('../data/train.csv')
train.head()
```


```python
train_data, val_data, train_value, val_value = train_test_split(train.drop('HasDetections', axis=1), train['HasDetections'], test_size = 0.3, random_state=1)
model = cb.CatBoostClassifier(iterations=50)
model.fit(X=train_data, y=train_value, eval_set=(val_data, val_value), cat_features=categories, verbose=True)
```


```python
model_path = '../models/catboost.cb'
model.save_model(model_path)
```

Оценим вклад различных свойств.


```python
feature_importance = model.get_feature_importance()
features = model.feature_names_


for feature_id in feature_importance.argsort()[::-1]:
    name = features[feature_id]
    importance = feature_importance[feature_id]
    print(f'{name:30}\t\t{importance}')
```

#### Вклад свойств с хэшированием и нормализацией  
SmartScreen                   		35.01980759589038  
AVProductStatesIdentifier     		9.812049041266924  
AVProductsInstalled           		8.278298485088444  
EngineVersion                 		4.905332359752594  
AppVersion                    		4.525396104137587  
Wdft_RegionIdentifier         		3.710558372212576  
Census_TotalPhysicalRAM       		3.3809601522649606  
Census_InternalPrimaryDiagonalDisplaySizeInInches		2.291771640456253  
Census_OSInstallTypeName      		2.09457857073761  
OsBuild                       		1.7005163406907138  
CountryIdentifier             		1.6766089015360062  
Census_ActivationChannel      		1.561207224977915  
Wdft_IsGamer                  		1.5218551942132692  
Census_OSUILocaleIdentifier   		1.2388321522557095  
Census_PrimaryDiskTotalCapacity		1.2214453664096594  
Census_IsVirtualDevice        		1.1576236610614996  
LocaleEnglishNameIdentifier   		1.0871774473888194  
IeVerIdentifier               		1.0617879020130983  
Census_OSVersion              		0.9063262170630022  
Census_OSBuildRevision        		0.87257207125536  
DefaultBrowsersIdentifier     		0.7916332563102689  
RtpStateBitfield              		0.7398820858667394  
Census_OSBranch               		0.7344278792737886  
IsProtected                   		0.6998906671435972  
Census_SystemVolumeTotalCapacity		0.5990725664050687  
Census_PrimaryDiskTypeName    		0.5739334221541832  
Census_OSEdition              		0.476994085217018  
Census_InternalBatteryNumberOfCharges		0.47564755298295186  
Census_FirmwareManufacturerIdentifier		0.47205920647251853  
Processor                     		0.41702798121864415  
Census_OSBuildNumber          		0.3719380337680338  
Census_OSSkuName              		0.35683513265154826  
Census_OSWUAutoUpdateOptionsName		0.31584014504413715  
Census_ProcessorCoreCount     		0.31013483393312347  
GeoNameIdentifier             		0.3094180934142084  
Census_GenuineStateName       		0.3017237267073591  
Census_PowerPlatformRoleName  		0.29520770369580335  
Census_ProcessorModelIdentifier		0.29047212257472305  
Census_InternalPrimaryDisplayResolutionVertical		0.2812446989991556  
AVProductsEnabled             		0.26277158015332225  
OsSuite                       		0.2499260557568877  
IsSxsPassiveMode              		0.22836582403223543  
Census_HasOpticalDiskDrive    		0.22213102674321336  
Census_MDC2FormFactor         		0.2183282741874917  
Census_FlightRing             		0.16949368369127688  
Census_InternalPrimaryDisplayResolutionHorizontal		0.16775577359560362  
OsBuildLab                    		0.153450572583479  
CityIdentifier                		0.13759466069341314  
Firewall                      		0.1324872432583472  
OsPlatformSubRelease          		0.1313927005588  
HasTpm                        		0.10266170890097152  
Census_ChassisTypeName        		0.0974209490408351  
SMode                         		0.0921618038519711  
OrganizationIdentifier        		0.07888451625834986  
Census_IsSecureBootEnabled    		0.07763425763437062  
Census_InternalBatteryType    		0.07690522207609853  
Census_FirmwareVersionIdentifier		0.07596688587894965  
Census_OSInstallLanguageIdentifier		0.07544472570771847  
Census_IsTouchEnabled         		0.05619450646010091  
Census_ProcessorClass         		0.055575126516415996  
Census_OEMNameIdentifier      		0.05369782029121442  
Census_OEMModelIdentifier     		0.0430883341134698  
Census_ProcessorManufacturerIdentifier		0.042169013462836906  
Census_IsPenCapable           		0.03667698300515288  
SkuEdition                    		0.03254860673190323  
PuaMode                       		0.03229043696041902  
UacLuaenable                  		0.02872589277865208  
Platform                      		0.027385549371883956  
AutoSampleOptIn               		0.002782271199335182  
Census_ThresholdOptIn         		0.0  
Census_IsAlwaysOnAlwaysConnectedCapable		0.0  
AvSigVersion                  		0.0  
IsBeta                        		0.0  
Census_IsWIMBootEnabled       		0.0  
Census_OSArchitecture         		0.0  
Census_IsFlightsDisabled      		0.0  
Census_IsFlightingInternal    		0.0  
Census_IsPortableOperatingSystem		0.0  
OsVer                         		0.0  
Census_DeviceFamily           		0.0  
ProductName                   		0.0  


```python
del train_data, val_data, train_value, val_value, train
```


```python
test, submit = load_data('../data/test.csv', ids=True)
test.head()
```


```python
predict = model.predict_proba(test)[:,1]
submit['HasDetections'] = predict
submit.to_csv('../kaggle_submissions/catboost.csv', index=False)
```

Public Score 0.65145  
Private Score 0.60059  
