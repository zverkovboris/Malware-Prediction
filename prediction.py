import json
import sys
from malware_ml.database import DBLog
from malware_ml.prepare_data import DEFAULT_TARGET, DEFAULT_ID
from malware_ml.model import apply_model, load_model
import pandas as pd

DEFAULT_MODEL_PATH = './models/lgbm.pkl'
DEFAULT_DB_PATH = './database/log.db'


if __name__ == '__main__':
    args = sys.argv
    if len(args) == 1:
        model_path = DEFAULT_MODEL_PATH
    else:
        model_path = sys.argv[-1]
    model = load_model(model_path)
    print('Send json string to get prediction.')
    print('Send \'stop\' string to finish.')
    db_log = DBLog(DEFAULT_DB_PATH)
    db_log.drop_table()
    n = 0
    # while True:
    d = pd.read_csv('../ML/data/train.csv', chunksize=1, nrows=1000)
    for i in d:
        input_string = i.to_json()
        if input_string == 'stop':
            break
        data = json.loads(input_string)
        # Если взять пример из датасета, то он будет содержать строковый индекс
        target = data.get(DEFAULT_TARGET)[str(n)]
        identifier = data.get(DEFAULT_ID)[str(n)]
        n += 1
        prediction = apply_model(model, data)
        db_log.insert(identifier, prediction, target)
    db_log.close()
